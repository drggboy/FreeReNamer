---
description: Tauri生产环境注意事项和修复方案
globs: **/*.tsx,**/*.ts,**/styles.css
---

# Tauri 生产环境指南

本规则涵盖在生产环境中部署Tauri React应用程序时的常见问题和解决方案。

## 环境检测

始终正确检测Tauri生产环境：

```typescript
const isProductionTauri = () => {
  const isProduction = import.meta.env.PROD;
  // @ts-ignore
  const isTauri = typeof window !== 'undefined' && window.__TAURI_IPC__;
  return isProduction && isTauri;
};
```

## 常见生产环境问题

### 1. 右键菜单和用户选择
生产构建通常禁用右键菜单，这可能会干扰文本编辑器：

```css
/* 生产环境右键菜单禁用 */
.disable-context-menu {
  -webkit-user-select: none;
  -webkit-context-menu: none;
  -webkit-touch-callout: none;
  -webkit-tap-highlight-color: transparent;
}

/* 在输入元素中允许文本选择 */
.disable-context-menu input, 
.disable-context-menu textarea, 
.disable-context-menu [contenteditable="true"] {
  -webkit-user-select: text !important;
  -webkit-context-menu: auto !important;
  user-select: text !important;
}
```

### 2. 滚动和渲染问题
Tauri应用程序可能与Web浏览器有不同的渲染行为：

- 使用硬件加速：`transform: translateZ(0)`
- 为动画元素添加 `will-change` 属性
- 需要时使用 `render(true)` 调用强制重新渲染

### 3. 窗口管理
参考 [tauri-window.ts](mdc:src/lib/tauri-window.ts) 了解窗口管理工具：

```typescript
export const isTauriEnvironment = (): boolean => {
  return typeof window !== 'undefined' && Boolean(window.__TAURI__);
};
```

## 开发环境与生产环境的差异

### Monaco Editor
- 不同的预加载行为
- 光标可见性问题
- 滚动同步问题

### 性能考虑
- 资源打包差异
- 内存使用模式
- 渲染管道变化

## 生产环境CSS修复

```css
/* Tauri特定的滚动条修复 */
[data-radix-scroll-area-viewport] {
  scrollbar-width: none;
  -ms-overflow-style: none;
}

[data-radix-scroll-area-viewport]::-webkit-scrollbar {
  display: none !important;
}

/* Tauri窗口的Toast定位 */
[data-sonner-toaster] {
  position: fixed !important;
  top: 60px !important;
  right: 16px !important;
  z-index: 2147483647 !important;
}
```

## 调试技巧

1. **控制台日志**: 为调试添加生产环境特定的日志记录
2. **错误边界**: 为生产构建实现健壮的错误处理
3. **性能监控**: 跟踪渲染性能差异

## 最佳实践

1. 始终使用实际的生产构建进行测试，而不仅仅是开发模式
2. 为失败的组件实现优雅的回退
3. 使用环境特定的配置
4. 监控WebView特定的问题

## 参考文件

- [根组件](mdc:src/routes/__root.tsx) - 环境检测和右键菜单处理
- [主入口](mdc:src/main.tsx) - 应用程序初始化
- [样式](mdc:src/styles.css) - 生产环境特定的CSS修复